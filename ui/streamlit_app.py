"""
Aplicaci√≥n Streamlit - Dimensionador Call Center
"""

import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from plotly.subplots import make_subplots
from datetime import datetime, date, timedelta
import sys
from pathlib import Path
import logging

# Configurar p√°gina
st.set_page_config(
    page_title="Dimensionador Call Center",
    page_icon="üìû",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Agregar path para imports
sys.path.append(str(Path(__file__).parent.parent))

# Configurar logging
logging.basicConfig(level=logging.ERROR)  # Solo errores en Streamlit

# CSS personalizado con colores corporativos
st.markdown("""
<style>
    .main-header {
        background: linear-gradient(135deg, #da7756 0%, #c2563a 100%);
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 2rem;
        color: white;
        text-align: center;
    }
    
    .metric-card {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid #da7756;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .scenario-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        border: 2px solid #da7756;
    }
    
    .recommendation-box {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
    }
    
    .status-success {
        background: #d4edda;
        color: #155724;
        padding: 0.5rem;
        border-radius: 4px;
        margin: 0.5rem 0;
    }
    
    .status-warning {
        background: #fff3cd;
        color: #856404;
        padding: 0.5rem;
        border-radius: 4px;
        margin: 0.5rem 0;
    }
    
    /* Sidebar BALANCEADO */
    .css-1d391kg {
        padding: 1.5rem 1rem !important;
        background: #ffffff !important;
    }
    
    /* Espaciado balanceado entre secciones */
    .stMarkdown h3, .stMarkdown h2 {
        margin-top: 1rem !important;
        margin-bottom: 0.5rem !important;
    }
    
    .stSelectbox, .stDateInput {
        margin-bottom: 0.5rem !important;
    }
    
    /* TODOS los botones - base */
    .stButton > button {
        border: none !important;
        padding: 12px 24px !important;
        font-weight: 600 !important;
        font-size: 14px !important;
        border-radius: 6px !important;
        margin: 10px 0 !important;
        min-height: 44px !important;
        width: 100% !important;
        color: white !important;
    }
    
    /* PRIMARY = AZUL */
    .stButton > button[kind="primary"] {
        background: #2196f3 !important;
        box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3) !important;
    }
    
    /* Verde para bot√≥n intermedio - selector directo */
    .stButton > button:contains("Intermedio") {
        background-color: #4caf50 !important;
        color: white !important;
    }
    
    /* Morado para bot√≥n avanzado - selector directo */
    .stButton > button:contains("Avanzado") {
        background-color: #9c27b0 !important;
        color: white !important;
    }
    
    
    /* Inputs limpios y compactos */
    .stSelectbox > div > div, .stDateInput > div > div > div {
        border-radius: 4px !important;
        border: 1px solid #dee2e6 !important;
        font-size: 14px !important;
    }
    
    /* M√©tricas compactas */
    .stMetric {
        background: #f8f9fa !important;
        padding: 8px !important;
        border-radius: 4px !important;
        border-left: 3px solid #da7756 !important;
    }
</style>
""", unsafe_allow_html=True)

# Imports de m√≥dulos propios
try:
    from config.auth import auth_manager
    from data.sql_connector import sql_connector
    from data.data_analyzer import data_analyzer
    from engines.erlang_calculator import ErlangInputs
except ImportError as e:
    st.error(f"‚ùå Error importando m√≥dulos: {e}")
    st.stop()

def show_login():
    """Mostrar pantalla de login minimalista"""
    
    # Espaciado superior
    st.markdown("<br><br>", unsafe_allow_html=True)
    
    # Layout centrado
    col1, col2, col3 = st.columns([1, 1, 1])
    
    with col2:
        # Header con estilo
        st.markdown("""
        <div style="text-align: center; margin-bottom: 2rem;">
            <h1 style="color: #da7756; margin-bottom: 0.5rem;">AMG</h1>
            <p style="color: #6b7280; margin-bottom: 2rem;">Sistema de dimensionamiento</p>
        </div>
        """, unsafe_allow_html=True)
        
        # Formulario simple
        with st.form("login_form", clear_on_submit=False):
            password = st.text_input(
                "Clave de acceso",
                type="password", 
                placeholder="Ingresa tu clave de acceso"
            )
            
            submitted = st.form_submit_button(
                "üîì Ingresar", 
                use_container_width=True,
                type="primary"
            )
            
            if submitted:
                if auth_manager.authenticate(password):
                    st.success("‚úÖ Acceso concedido")
                    st.rerun()
                else:
                    st.error("‚ùå Clave incorrecta")
        
        # Informaci√≥n m√≠nima
        st.markdown("""
        <div style="text-align: center; margin-top: 2rem; color: #9ca3af; font-size: 0.9rem;">
            Sistema para operaciones Telecom
        </div>
        """, unsafe_allow_html=True)

def show_nueva_campana_app():
    """Dashboard para dimensionamiento de campa√±a nueva"""
    
    # Header
    st.markdown("""
    <div class="main-header">
        <h1>üöÄ Dimensionador - Campa√±a Nueva</h1>
        <p>C√°lculo de staffing para nueva operaci√≥n</p>
    </div>
    """, unsafe_allow_html=True)
    
    # Navegaci√≥n y logout en sidebar
    show_sidebar_navigation()
    
    # Contenido principal - placeholder por ahora
    st.markdown("## üîß En Construcci√≥n")
    st.info("Esta funcionalidad ser√° implementada pr√≥ximamente. Aqu√≠ podr√°s dimensionar campa√±as nuevas con inputs manuales.")
    
    st.markdown("""
    ### üìã Funcionalidades Planificadas:
    - **Inputs manuales** de volumen esperado y TMO
    - **C√°lculos Erlang C** para dimensionamiento b√°sico
    - **Escenarios m√∫ltiples** (optimista, conservador, realista)
    - **Recomendaciones** basadas en mejores pr√°cticas
    - **Exportaci√≥n** de resultados
    """)

def show_analysis_selection():
    """Pantalla de selecci√≥n de tipo de an√°lisis"""
    
    
    # Header principal compacto
    modo_actual = st.session_state.get('modo_operacion', 'existente')
    tipo_campana = "Campa√±a Existente" if modo_actual == 'existente' else "Campa√±a Nueva"
    
    st.markdown(f"""
    <div style="background: linear-gradient(135deg, #da7756 0%, #c2563a 100%); padding: 0.8rem; 
                border-radius: 10px; margin-bottom: 0.8rem; color: white; text-align: center;">
        <h2 style="margin: 0; margin-bottom: 0; font-size: 1.8rem; line-height: 1.1;">üéØ Selecciona el Tipo de An√°lisis</h2>
        <p style="margin: 0; margin-top: 0; font-size: 0.9rem; line-height: 1.2;">Para tu {tipo_campana}</p>
    </div>
    """, unsafe_allow_html=True)
    
    # Layout horizontal de selecci√≥n - 3 columnas
    col1, col2, col3 = st.columns(3)
    
    # Opci√≥n 1: An√°lisis B√°sico
    with col1:
        st.markdown("""
        <div style="border: 2px solid #2196f3; border-radius: 12px; padding: 1.2rem; margin-bottom: 0.8rem; 
                    background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%); text-align: center; min-height: 180px;">
            <h3 style="color: #2196f3; margin: 0; margin-bottom: 0.8rem; font-size: 1.2rem;">‚ö° An√°lisis B√°sico</h3>
            <p style="color: #6b7280; margin: 0; margin-bottom: 0.8rem; font-size: 0.95rem; line-height: 1.3;">
                Dimensionamiento r√°pido con Erlang C
            </p>
            <div style="background: #e3f2fd; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; font-size: 0.85rem; text-align: left;">
                <strong style="color: #1976d2;">‚ö° Caracter√≠sticas:</strong><br>
                ‚Ä¢ C√°lculos instant√°neos (< 1 seg)<br>
                ‚Ä¢ Dimensionamiento preciso<br>
                ‚Ä¢ Resultados inmediatos<br>
                ‚Ä¢ Ideal para an√°lisis r√°pido
            </div>
        </div>
        """, unsafe_allow_html=True)
        
        if st.button(
            "‚ö° Usar An√°lisis B√°sico", 
            type="primary", 
            use_container_width=True,
            key="btn_basico"
        ):
            st.session_state['tipo_analisis'] = 'basico'
            st.session_state['analisis_seleccionado'] = True
            st.rerun()
    
    # Opci√≥n 2: An√°lisis Intermedio
    with col2:
        st.markdown("""
        <div style="border: 2px solid #4caf50; border-radius: 12px; padding: 1.2rem; margin-bottom: 0.8rem; 
                    background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%); text-align: center; min-height: 180px;">
            <h3 style="color: #4caf50; margin: 0; margin-bottom: 0.8rem; font-size: 1.2rem;">üìä An√°lisis Intermedio</h3>
            <p style="color: #6b7280; margin: 0; margin-bottom: 0.8rem; font-size: 0.95rem; line-height: 1.3;">
                Simulaci√≥n con abandonos incluidos
            </p>
            <div style="background: #e8f5e8; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; font-size: 0.85rem; text-align: left;">
                <strong style="color: #388e3c;">üìä Caracter√≠sticas:</strong><br>
                ‚Ä¢ Simulaciones con SimPy<br>
                ‚Ä¢ Incluye abandonos de llamadas<br>
                ‚Ä¢ An√°lisis m√°s realista<br>
                ‚Ä¢ Tiempo: 2-5 segundos
            </div>
        </div>
        """, unsafe_allow_html=True)
        
        
        
        # Bot√≥n HTML directo - VERDE
        intermedio_clicked = st.markdown("""
        <form action="" method="get">
            <button type="submit" name="btn_intermedio" value="true" 
                    style="background-color: #4caf50; color: white; border: none; 
                           border-radius: 8px; padding: 12px 24px; font-weight: 600; 
                           width: 100%; cursor: pointer; font-size: 14px;">
                üìä Usar An√°lisis Intermedio
            </button>
        </form>
        """, unsafe_allow_html=True)
        
        # Detectar si se hizo clic
        if st.query_params.get("btn_intermedio") == "true":
            st.session_state['tipo_analisis'] = 'intermedio'
            st.session_state['analisis_seleccionado'] = True
            st.query_params.clear()
            st.rerun()
    
    # Opci√≥n 3: An√°lisis Avanzado
    with col3:
        st.markdown("""
        <div style="border: 2px solid #9c27b0; border-radius: 12px; padding: 1.2rem; margin-bottom: 0.8rem; 
                    background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%); text-align: center; min-height: 180px;">
            <h3 style="color: #9c27b0; margin: 0; margin-bottom: 0.8rem; font-size: 1.2rem;">üî¨ An√°lisis Avanzado</h3>
            <p style="color: #6b7280; margin: 0; margin-bottom: 0.8rem; font-size: 0.95rem; line-height: 1.3;">
                Shrinkage + validaci√≥n autom√°tica
            </p>
            <div style="background: #f3e5f5; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; font-size: 0.85rem; text-align: left;">
                <strong style="color: #7b1fa2;">üî¨ Caracter√≠sticas:</strong><br>
                ‚Ä¢ Validaci√≥n autom√°tica<br>
                ‚Ä¢ Incluye shrinkage detallado<br>
                ‚Ä¢ M√∫ltiples escenarios<br>
                ‚Ä¢ An√°lisis m√°s completo
            </div>
        </div>
        """, unsafe_allow_html=True)
        
        
        # Bot√≥n HTML directo - MORADO
        avanzado_clicked = st.markdown("""
        <form action="" method="get">
            <button type="submit" name="btn_avanzado" value="true" 
                    style="background-color: #9c27b0; color: white; border: none; 
                           border-radius: 8px; padding: 12px 24px; font-weight: 600; 
                           width: 100%; cursor: pointer; font-size: 14px;">
                üî¨ Usar An√°lisis Avanzado
            </button>
        </form>
        """, unsafe_allow_html=True)
        
        # Detectar si se hizo clic
        if st.query_params.get("btn_avanzado") == "true":
            st.session_state['tipo_analisis'] = 'avanzado'
            st.session_state['analisis_seleccionado'] = True
            st.query_params.clear()
            st.rerun()
    
    # Sidebar con navegaci√≥n
    with st.sidebar:
        st.markdown("### üìã Configuraci√≥n Actual")
        st.info(f"üéØ {tipo_campana}")
        
        st.markdown("---")
        
        # Bot√≥n para volver a selecci√≥n de campa√±a
        if st.button("‚¨ÖÔ∏è Cambiar Tipo", use_container_width=True):
            st.session_state['modo_seleccionado'] = False
            if 'modo_operacion' in st.session_state:
                del st.session_state['modo_operacion']
            st.rerun()
        
        # Bot√≥n logout
        if st.button("üö™ Cerrar Sesi√≥n", type="secondary", use_container_width=True):
            # Limpiar todas las variables de sesi√≥n
            for key in ['modo_operacion', 'modo_seleccionado', 'tipo_analisis', 'analisis_seleccionado']:
                if key in st.session_state:
                    del st.session_state[key]
            auth_manager.logout()
            st.rerun()

def show_sidebar_navigation():
    """Sidebar con navegaci√≥n com√∫n"""
    with st.sidebar:
        st.markdown("### üìã Configuraci√≥n Actual")
        
        modo_actual = st.session_state.get('modo_operacion', 'existente')
        tipo_analisis = st.session_state.get('tipo_analisis', 'basico')
        
        if modo_actual == 'existente':
            st.info("üéØ Campa√±a Existente")
        else:
            st.info("üéØ Campa√±a Nueva")
        
        # Mostrar tipo de an√°lisis
        analisis_nombres = {
            'basico': '‚ö° B√°sico (Erlang C)',
            'intermedio': 'üìä Intermedio (SimPy)',
            'avanzado': 'üî¨ Avanzado (SimPy)'
        }
        st.success(f"üìã {analisis_nombres.get(tipo_analisis, 'B√°sico')}")
        
        st.markdown("---")
        
        # Bot√≥n para cambiar an√°lisis
        if st.button("üîÑ Cambiar An√°lisis", use_container_width=True):
            st.session_state['analisis_seleccionado'] = False
            if 'tipo_analisis' in st.session_state:
                del st.session_state['tipo_analisis']
            st.rerun()
        
        # Bot√≥n para cambiar campa√±a
        if st.button("‚¨ÖÔ∏è Cambiar Tipo", use_container_width=True):
            st.session_state['modo_seleccionado'] = False
            st.session_state['analisis_seleccionado'] = False
            for key in ['modo_operacion', 'tipo_analisis']:
                if key in st.session_state:
                    del st.session_state[key]
            st.rerun()
        
        # Bot√≥n logout
        if st.button("üö™ Cerrar Sesi√≥n", type="secondary", use_container_width=True):
            # Limpiar todas las variables de sesi√≥n
            for key in ['modo_operacion', 'modo_seleccionado', 'tipo_analisis', 'analisis_seleccionado']:
                if key in st.session_state:
                    del st.session_state[key]
            auth_manager.logout()
            st.rerun()

def show_main_app():
    """Mostrar aplicaci√≥n principal para campa√±a existente"""
    
    # Header
    st.markdown("""
    <div class="main-header">
        <h1>üìä Dimensionador - Datos Hist√≥ricos</h1>
        <p>An√°lisis inteligente basado en datos reales de SQL Server</p>
    </div>
    """, unsafe_allow_html=True)
    
    # Navegaci√≥n y logout en sidebar
    show_sidebar_navigation()
    
    # Sidebar MINIMALISTA - REDISE√ëO COMPLETO
    with st.sidebar:
        # Obtener rango de fechas disponibles
        try:
            with st.spinner("‚è≥"):
                date_range = sql_connector.get_available_date_range()
                min_date = date_range['fecha_min']
                max_date = date_range['fecha_max']
                
        except Exception as e:
            st.error(f"‚ùå {e}")
            st.stop()
        
        # HEADER COMPACTO
        st.markdown("## üìä Dimensionador")
        
        # FECHAS - COMPACTAS EN 2 COLUMNAS
        st.markdown("**üìÖ Per√≠odo de An√°lisis**")
        col1, col2 = st.columns(2)
        with col1:
            start_date = st.date_input("Inicio", value=min_date, min_value=min_date, max_value=max_date)
        with col2:
            end_date = st.date_input("Fin", value=max_date, min_value=min_date, max_value=max_date)
        
        if start_date > end_date:
            st.error("‚ùå Fechas inv√°lidas")
            st.stop()
        
        # PAR√ÅMETROS - COMPACTOS EN 2 COLUMNAS
        st.markdown("**üéØ Par√°metros SLA**")
        col1, col2 = st.columns(2)
        with col1:
            sla_target = st.selectbox("SLA %", [80, 85, 90, 95], index=2)
        with col2:
            answer_time_target = st.selectbox("Tiempo (s)", [15, 20, 25, 30], index=1)
        
        # SHRINKAGE - UNA L√çNEA
        shrinkage_pct = st.selectbox("‚öôÔ∏è Shrinkage (%)", [10, 15, 20, 25], index=1)
        
        # BOT√ìN PRINCIPAL 
        st.markdown("<br>", unsafe_allow_html=True)
        analyze_btn = st.button(
            "üöÄ Ejecutar An√°lisis",
            type="primary",
            use_container_width=True
        )
        
        # INFO COMPACTA
        st.markdown("---")
        col1, col2 = st.columns(2)
        with col1:
            st.metric("üìä Registros", f"{date_range['total_registros']:,}")
        with col2:
            st.metric("üë• Asesores", date_range['total_asesores'])
        
        st.caption(f"üìÖ Rango: {min_date} ‚Üí {max_date}")
    
    # Contenido principal
    if analyze_btn:
        execute_analysis(start_date, end_date, sla_target, answer_time_target, shrinkage_pct)
    else:
        show_welcome_screen(date_range if 'date_range' in locals() else None)

def show_welcome_screen(date_range):
    """Pantalla de bienvenida"""
    
    st.markdown("## üëã Bienvenido al Dimensionador Call Center")
    
    if date_range:
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            st.markdown("""
            <div class="metric-card">
                <h3>üìû Total Registros</h3>
                <h2>{:,}</h2>
            </div>
            """.format(date_range['total_registros']), unsafe_allow_html=True)
        
        with col2:
            st.markdown("""
            <div class="metric-card">
                <h3>üë• Total Asesores</h3>
                <h2>{}</h2>
            </div>
            """.format(date_range['total_asesores']), unsafe_allow_html=True)
        
        with col3:
            st.markdown("""
            <div class="metric-card">
                <h3>üìÖ Fecha Inicio</h3>
                <h2>{}</h2>
            </div>
            """.format(date_range['fecha_min']), unsafe_allow_html=True)
        
        with col4:
            st.markdown("""
            <div class="metric-card">
                <h3>üìÖ Fecha Fin</h3>
                <h2>{}</h2>
            </div>
            """.format(date_range['fecha_max']), unsafe_allow_html=True)
    
    st.markdown("""
    ### üéØ C√≥mo usar el sistema:
    
    1. **üìÖ Selecciona el per√≠odo** de an√°lisis en el panel izquierdo
    2. **‚öôÔ∏è Ajusta los par√°metros** de SLA y shrinkage seg√∫n tus necesidades
    3. **üöÄ Ejecuta el an√°lisis** para obtener dimensionamiento basado en datos reales
    4. **üìä Revisa los resultados** y escenarios recomendados
    5. **üìÑ Exporta los reportes** en Excel para presentaciones
    
    ### ‚ú® Caracter√≠sticas principales:
    
    - **An√°lisis en tiempo real** con datos de SQL Server
    - **M√∫ltiples escenarios** de dimensionamiento (promedio, pico, conservador, optimista)
    - **Validaci√≥n autom√°tica** contra datos hist√≥ricos reales
    - **Recomendaciones inteligentes** basadas en an√°lisis estad√≠stico
    - **Exportaci√≥n a Excel** con gr√°ficos integrados
    """)

def execute_analysis(start_date, end_date, sla_target, answer_time_target, shrinkage_pct):
    """Ejecutar an√°lisis completo"""
    
    st.markdown("## üîç Ejecutando An√°lisis...")
    
    # Barra de progreso
    progress_bar = st.progress(0)
    status_text = st.empty()
    
    try:
        # Paso 1: Obtener datos
        status_text.text("üìä Obteniendo datos hist√≥ricos...")
        progress_bar.progress(20)
        
        # Ejecutar an√°lisis completo
        with st.spinner("Procesando an√°lisis completo..."):
            results = data_analyzer.analyze_campaign_complete(
                start_date=start_date,
                end_date=end_date,
                sla_target=sla_target / 100,  # Convertir a decimal
                answer_time_target=answer_time_target,
                shrinkage_pct=shrinkage_pct
            )
        
        progress_bar.progress(100)
        status_text.text("‚úÖ An√°lisis completado exitosamente")
        
        # Mostrar resultados
        show_results(results)
        
    except Exception as e:
        st.error(f"‚ùå Error en el an√°lisis: {e}")
        st.exception(e)

def show_results(results):
    """Mostrar resultados del an√°lisis"""
    
    st.markdown("## üìä Resultados del An√°lisis")
    
    # Resumen ejecutivo
    summary = results['summary']
    
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric(
            "üë• Agentes Recomendados",
            summary['agentes_recomendados'],
            delta=f"vs {summary['agentes_actuales_promedio']:.0f} actuales"
        )
    
    with col2:
        st.metric(
            "üéØ Escenario Base",
            summary['escenario_base'].upper(),
            delta=f"{summary['precision_modelo']:.1f}% precisi√≥n"
        )
    
    with col3:
        st.metric(
            "üìà SLA Actual Estimado",
            f"{summary['sla_actual_estimado']:.1f}%",
            delta=f"vs {results['targets']['sla_target']:.0f}% objetivo"
        )
    
    with col4:
        st.metric(
            "‚è≥ TME Promedio Real",
            f"{summary['tme_promedio_real']:.1f}s",
            delta=f"vs {results['targets']['answer_time_target']}s objetivo"
        )
    
    # Tabs para organizar resultados
    tab1, tab2, tab3, tab4 = st.tabs(["üìã Escenarios", "üìà Gr√°ficos", "üí° Recomendaciones", "üìÑ Exportar"])
    
    with tab1:
        show_scenarios_tab(results)
    
    with tab2:
        show_charts_tab(results)
    
    with tab3:
        show_recommendations_tab(results)
    
    with tab4:
        show_export_tab(results)

def show_scenarios_tab(results):
    """Tab de escenarios de dimensionamiento"""
    
    st.markdown("### üéØ Escenarios de Dimensionamiento Calculados")
    
    scenarios = results['dimensioning_results']['scenarios']
    
    cols = st.columns(2)
    
    for i, (scenario_name, scenario_data) in enumerate(scenarios.items()):
        col = cols[i % 2]
        
        with col:
            # Determinar color basado en recomendaci√≥n
            is_recommended = scenario_name == results['summary']['escenario_base']
            border_color = "#da7756" if is_recommended else "#e9ecef"
            
            st.markdown(f"""
            <div style="border: 2px solid {border_color}; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: white;">
                <h4 style="color: #da7756; margin-bottom: 1rem;">
                    {scenario_name.upper()} {'‚≠ê RECOMENDADO' if is_recommended else ''}
                </h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <div><strong>üë• Agentes:</strong> {scenario_data['agents_with_shrinkage']}</div>
                    <div><strong>üìà Utilizaci√≥n:</strong> {scenario_data['utilization']:.1f}%</div>
                    <div><strong>üéØ Nivel Servicio:</strong> {scenario_data['service_level']:.1f}%</div>
                    <div><strong>‚è±Ô∏è Tiempo Espera:</strong> {scenario_data['average_wait_time']:.1f}s</div>
                    <div><strong>üìä Prob. Esperar:</strong> {scenario_data['probability_of_wait']:.1f}%</div>
                    <div><strong>üî• Intensidad:</strong> {scenario_data['traffic_intensity']:.1f} Erlangs</div>
                </div>
            </div>
            """, unsafe_allow_html=True)
    
    # Tabla comparativa
    st.markdown("### üìä Comparaci√≥n de Escenarios")
    
    df_scenarios = pd.DataFrame([
        {
            'Escenario': name.upper(),
            'Agentes con Shrinkage': data['agents_with_shrinkage'],
            'Nivel de Servicio (%)': data['service_level'],
            'Tiempo Espera (s)': data['average_wait_time'],
            'Utilizaci√≥n (%)': data['utilization'],
            'Probabilidad Esperar (%)': data['probability_of_wait']
        }
        for name, data in scenarios.items()
    ])
    
    # Destacar escenario recomendado
    def highlight_recommended(row):
        if row['Escenario'].lower() == results['summary']['escenario_base'].upper():
            return ['background-color: #fff3cd'] * len(row)
        return [''] * len(row)
    
    st.dataframe(
        df_scenarios.style.apply(highlight_recommended, axis=1),
        use_container_width=True
    )

def show_charts_tab(results):
    """Tab de gr√°ficos y visualizaciones"""
    
    st.markdown("### üìà An√°lisis Visual")
    
    # Gr√°fico de escenarios
    scenarios = results['dimensioning_results']['scenarios']
    
    # Preparar datos para gr√°fico
    scenario_names = list(scenarios.keys())
    agents_required = [data['agents_with_shrinkage'] for data in scenarios.values()]
    service_levels = [data['service_level'] for data in scenarios.values()]
    wait_times = [data['average_wait_time'] for data in scenarios.values()]
    
    # Gr√°fico de barras - Agentes por escenario
    fig1 = go.Figure(data=[
        go.Bar(
            x=scenario_names,
            y=agents_required,
            text=agents_required,
            textposition='auto',
            marker_color='#da7756'
        )
    ])
    
    fig1.update_layout(
        title="üë• Agentes Requeridos por Escenario",
        xaxis_title="Escenario",
        yaxis_title="N√∫mero de Agentes",
        showlegend=False
    )
    
    st.plotly_chart(fig1, use_container_width=True)
    
    # Gr√°fico de dispersi√≥n - SLA vs Tiempo de Espera
    fig2 = go.Figure(data=[
        go.Scatter(
            x=wait_times,
            y=service_levels,
            mode='markers+text',
            text=scenario_names,
            textposition="top center",
            marker=dict(
                size=agents_required,
                sizemode='diameter',
                sizeref=max(agents_required)/50,
                color='#da7756',
                opacity=0.7
            )
        )
    ])
    
    fig2.update_layout(
        title="üéØ Nivel de Servicio vs Tiempo de Espera",
        xaxis_title="Tiempo de Espera (segundos)",
        yaxis_title="Nivel de Servicio (%)",
        showlegend=False
    )
    
    # L√≠nea objetivo de SLA
    fig2.add_hline(
        y=results['targets']['sla_target'],
        line_dash="dash",
        line_color="red",
        annotation_text=f"SLA Objetivo: {results['targets']['sla_target']:.0f}%"
    )
    
    st.plotly_chart(fig2, use_container_width=True)
    
    # Patrones hist√≥ricos si est√°n disponibles
    if 'historical_analysis' in results:
        historical = results['historical_analysis']
        
        if 'hourly_profile' in historical['volume_analysis']:
            hourly_data = historical['volume_analysis']['hourly_profile']
            
            hours = list(hourly_data.keys())
            volumes = list(hourly_data.values())
            
            fig3 = go.Figure(data=[
                go.Bar(
                    x=hours,
                    y=volumes,
                    marker_color='#da7756'
                )
            ])
            
            fig3.update_layout(
                title="üìä Perfil de Volumen por Hora",
                xaxis_title="Hora del D√≠a",
                yaxis_title="N√∫mero de Llamadas",
                showlegend=False
            )
            
            st.plotly_chart(fig3, use_container_width=True)

def show_recommendations_tab(results):
    """Tab de recomendaciones"""
    
    st.markdown("### üí° Recomendaciones Inteligentes")
    
    recommendations = results.get('recommendations', {})
    
    # Recomendaciones de dimensionamiento
    if 'dimensionamiento' in recommendations:
        st.markdown("#### üéØ Dimensionamiento")
        for rec in recommendations['dimensionamiento']:
            st.markdown(f"""
            <div class="recommendation-box">
                <strong>{rec['tipo']}:</strong> {rec['descripcion']}<br>
                <em>{rec.get('justificacion', '')}</em>
            </div>
            """, unsafe_allow_html=True)
    
    # Recomendaciones operacionales
    if 'operacional' in recommendations:
        st.markdown("#### ‚öôÔ∏è Operacionales")
        for rec in recommendations['operacional']:
            st.markdown(f"""
            <div class="recommendation-box">
                <strong>{rec['tipo']}:</strong> {rec['descripcion']}<br>
                <em>{rec.get('detalle', '')}</em>
            </div>
            """, unsafe_allow_html=True)
    
    # Oportunidades de mejora
    if 'mejoras' in recommendations:
        st.markdown("#### üöÄ Oportunidades de Mejora")
        for rec in recommendations['mejoras']:
            st.markdown(f"""
            <div class="recommendation-box">
                <strong>{rec['tipo']}:</strong> {rec['descripcion']}<br>
                <em>{rec.get('sugerencia', '')}</em>
            </div>
            """, unsafe_allow_html=True)
    
    # An√°lisis de precisi√≥n
    if 'validation_results' in results:
        validation = results['validation_results']
        best_scenario = validation.get('best_scenario', {})
        
        if best_scenario:
            st.markdown("#### ‚úÖ Validaci√≥n del Modelo")
            
            precision = best_scenario.get('precision_tme', 0)
            
            if precision > 80:
                status_class = "status-success"
                status_text = "Excelente precisi√≥n del modelo"
            elif precision > 60:
                status_class = "status-warning"  
                status_text = "Precisi√≥n aceptable del modelo"
            else:
                status_class = "status-warning"
                status_text = "Modelo requiere calibraci√≥n"
            
            st.markdown(f"""
            <div class="{status_class}">
                <strong>{status_text}:</strong> {precision:.1f}% de precisi√≥n en predicci√≥n de tiempos de espera
            </div>
            """, unsafe_allow_html=True)

def show_export_tab(results):
    """Tab de exportaci√≥n"""
    
    st.markdown("### üìÑ Exportar Resultados")
    
    st.markdown("""
    Genera un reporte completo en Excel con:
    - üìä Resumen ejecutivo
    - üìà Gr√°ficos de escenarios
    - üí° Recomendaciones detalladas
    - üìã Datos de an√°lisis
    - ‚úÖ Justificaciones t√©cnicas
    """)
    
    col1, col2 = st.columns(2)
    
    with col1:
        if st.button("üìä Exportar Reporte Completo", type="primary", use_container_width=True):
            # Aqu√≠ ir√≠a la l√≥gica de exportaci√≥n
            st.success("‚úÖ Reporte generado exitosamente")
            st.download_button(
                label="‚¨áÔ∏è Descargar Excel",
                data="placeholder",  # Aqu√≠ ir√≠a el archivo Excel real
                file_name=f"dimensionamiento_call_center_{datetime.now().strftime('%Y%m%d_%H%M')}.xlsx",
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            )
    
    with col2:
        if st.button("üìã Exportar Solo Datos", type="secondary", use_container_width=True):
            # Crear CSV con datos principales
            scenarios = results['dimensioning_results']['scenarios']
            df_export = pd.DataFrame([
                {
                    'Escenario': name,
                    'Agentes_Requeridos': data['agents_required'],
                    'Agentes_Con_Shrinkage': data['agents_with_shrinkage'],
                    'Nivel_Servicio_Pct': data['service_level'],
                    'Tiempo_Espera_Seg': data['average_wait_time'],
                    'Utilizacion_Pct': data['utilization'],
                    'Probabilidad_Esperar_Pct': data['probability_of_wait'],
                    'Intensidad_Trafico': data['traffic_intensity']
                }
                for name, data in scenarios.items()
            ])
            
            csv = df_export.to_csv(index=False)
            st.download_button(
                label="‚¨áÔ∏è Descargar CSV",
                data=csv,
                file_name=f"escenarios_dimensionamiento_{datetime.now().strftime('%Y%m%d_%H%M')}.csv",
                mime="text/csv"
            )

def show_mode_selection():
    """Pantalla de selecci√≥n de modo de operaci√≥n"""
    
    # Header principal compacto
    st.markdown("""
    <div style="background: linear-gradient(135deg, #da7756 0%, #c2563a 100%); padding: 0.8rem; 
                border-radius: 10px; margin-bottom: 0.8rem; color: white; text-align: center;">
        <h2 style="margin: 0; margin-bottom: 0; font-size: 2rem; line-height: 1.1;">üéØ Selecciona el Tipo de An√°lisis</h2>
        <p style="margin: 0; margin-top: 0; font-size: 1rem; line-height: 1.2;">Elige el modo de operaci√≥n para tu dimensionamiento</p>
    </div>
    """, unsafe_allow_html=True)
    
    # Layout horizontal de selecci√≥n
    col1, col2 = st.columns(2)
    
    # Opci√≥n 1: Campa√±a Existente
    with col1:
        st.markdown("""
        <div style="border: 2px solid #da7756; border-radius: 12px; padding: 1.2rem; margin-bottom: 0.8rem; 
                    background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%); text-align: center; min-height: 180px;">
            <h3 style="color: #da7756; margin: 0; margin-bottom: 0.8rem; font-size: 1.2rem;">üìä Analizar Campa√±a Existente</h3>
            <p style="color: #6b7280; margin: 0; margin-bottom: 0.8rem; font-size: 0.95rem; line-height: 1.3;">
                Usa datos hist√≥ricos de la base de datos para an√°lisis precisos
            </p>
            <div style="background: #e3f2fd; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; font-size: 0.85rem; text-align: left;">
                <strong style="color: #1976d2;">‚úÖ Incluye:</strong><br>
                ‚Ä¢ An√°lisis de datos hist√≥ricos reales<br>
                ‚Ä¢ Validaci√≥n autom√°tica de modelos<br>
                ‚Ä¢ M√∫ltiples escenarios basados en patrones<br>
                ‚Ä¢ Comparaci√≥n predicho vs real
            </div>
        </div>
        """, unsafe_allow_html=True)
        
        if st.button(
            "üìä Usar Datos Hist√≥ricos", 
            type="primary", 
            use_container_width=True,
            key="btn_existente"
        ):
            st.session_state['modo_operacion'] = 'existente'
            st.session_state['modo_seleccionado'] = True
            st.rerun()
        
        # CSS para cambiar color despu√©s del bot√≥n
        st.markdown("""
        <style>
        button[data-testid="baseButton-primary"]:contains("Hist√≥ricos") {
            background-color: #da7756 !important;
        }
        </style>
        <script>
        setTimeout(() => {
            const btns = document.querySelectorAll('button');
            btns.forEach(b => {
                if (b.textContent.includes('Hist√≥ricos')) {
                    b.style.backgroundColor = '#da7756';
                    b.style.color = 'white';
                }
            });
        }, 10);
        </script>
        """, unsafe_allow_html=True)
    
    # Opci√≥n 2: Campa√±a Nueva
    with col2:
        st.markdown("""
        <div style="border: 2px solid #28a745; border-radius: 12px; padding: 1.2rem; margin-bottom: 0.8rem; 
                    background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%); text-align: center; min-height: 180px;">
            <h3 style="color: #28a745; margin: 0; margin-bottom: 0.8rem; font-size: 1.2rem;">üöÄ Dimensionar Campa√±a Nueva</h3>
            <p style="color: #6b7280; margin: 0; margin-bottom: 0.8rem; font-size: 0.95rem; line-height: 1.3;">
                Dimensionamiento para una nueva campa√±a con par√°metros estimados
            </p>
            <div style="background: #e8f5e8; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; font-size: 0.85rem; text-align: left;">
                <strong style="color: #2e7d32;">‚úÖ Incluye:</strong><br>
                ‚Ä¢ Inputs manuales de volumen y TMO<br>
                ‚Ä¢ C√°lculos basados en teor√≠a Erlang<br>
                ‚Ä¢ Escenarios optimista/conservador<br>
                ‚Ä¢ Recomendaciones para operaci√≥n nueva
            </div>
        </div>
        """, unsafe_allow_html=True)
        
        if st.button(
            "üöÄ Nueva Campa√±a", 
            type="secondary", 
            use_container_width=True,
            key="btn_nueva"
        ):
            st.session_state['modo_operacion'] = 'nueva'
            st.session_state['modo_seleccionado'] = True
            st.rerun()
        
        # CSS para cambiar color despu√©s del bot√≥n
        st.markdown("""
        <script>
        setTimeout(() => {
            const btns = document.querySelectorAll('button');
            btns.forEach(b => {
                if (b.textContent.includes('Nueva Campa√±a')) {
                    b.style.backgroundColor = '#28a745';
                    b.style.color = 'white';
                }
            });
        }, 10);
        </script>
        """, unsafe_allow_html=True)
    
    # Sidebar con logout
    with st.sidebar:
        st.markdown("---")
        st.markdown("### üë§ Usuario Autenticado")
        st.success("‚úÖ Sesi√≥n activa")
        
        if st.button("üö™ Cerrar Sesi√≥n", type="secondary", use_container_width=True):
            # Limpiar todas las variables de sesi√≥n
            for key in ['modo_operacion', 'modo_seleccionado']:
                if key in st.session_state:
                    del st.session_state[key]
            auth_manager.logout()
            st.rerun()
        
        st.markdown("---")
        st.markdown("""
        <div style="text-align: center; color: #6b7280; font-size: 0.9rem;">
            <p><strong>Call Center Dimensioner</strong></p>
            <p>Sistema AMG v2.0</p>
        </div>
        """, unsafe_allow_html=True)

def main():
    """Funci√≥n principal con nuevo flujo"""
    
    # Verificar autenticaci√≥n
    if not auth_manager.is_authenticated():
        show_login()
    else:
        # Verificar si se ha seleccionado modo de campa√±a
        if not st.session_state.get('modo_seleccionado', False):
            show_mode_selection()
        # Verificar si se ha seleccionado tipo de an√°lisis
        elif not st.session_state.get('analisis_seleccionado', False):
            show_analysis_selection()
        else:
            # Mostrar dashboard seg√∫n el modo y an√°lisis seleccionado
            modo = st.session_state.get('modo_operacion', 'existente')
            analisis = st.session_state.get('tipo_analisis', 'basico')
            
            if modo == 'existente':
                show_main_app()
            elif modo == 'nueva':
                show_nueva_campana_app()
            else:
                # Fallback - volver a selecci√≥n
                st.session_state['modo_seleccionado'] = False
                st.rerun()

if __name__ == "__main__":
    main()